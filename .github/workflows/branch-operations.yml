---
name: Branch Operations

'on':
  workflow_dispatch:
    inputs:
      operation:
        description: 'Select operation to perform'
        required: true
        type: choice
        options:
          - 'Cherry-pick Commit to Branch'
          - 'Create Branch from Upstream'
      commit_id:
        description: 'Commit SHA or ID to cherry-pick (required for Cherry-pick operation)'
        required: false
        type: string
      target_branch:
        description: 'Target branch name to cherry-pick into (required for Cherry-pick operation)'
        required: false
        type: string
      upstream_branch:
        description: 'Upstream branch name to create from, e.g., 0.81-stable, main (required for Create Branch operation)'
        required: false
        type: string
      new_branch_name:
        description: 'Name for new branch in your fork - leave empty to use same name as upstream (Create Branch operation)'
        required: false
        type: string
        default: ''

permissions:
  contents: write
  pull-requests: write

jobs:
  cherry-pick:
    if: ${{ github.event.inputs.operation == 'Cherry-pick Commit to Branch' }}
    runs-on: ubuntu-latest

    steps:
      - name: Validate inputs
        run: |
          if [ -z "${{ github.event.inputs.commit_id }}" ]; then
            echo "‚ùå Error: 'commit_id' is required for Cherry-pick operation"
            exit 1
          fi
          if [ -z "${{ github.event.inputs.target_branch }}" ]; then
            echo "‚ùå Error: 'target_branch' is required for Cherry-pick operation"
            exit 1
          fi

      - name: Install GitHub CLI
        run: |
          sudo apt update
          sudo apt install -y gh

      - name: Authenticate GitHub CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Clone repository
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh auth setup-git
          gh repo clone "${{ github.repository }}" repo
          cd repo
          git fetch origin

      - name: Configure Git
        working-directory: ./repo
        run: |
          git config user.name "React-Native-Windows Bot"
          git config user.email "53619745+rnbot@users.noreply.github.com"

      - name: Checkout target branch
        working-directory: ./repo
        run: |
          git checkout "${{ github.event.inputs.target_branch }}"
          git pull origin "${{ github.event.inputs.target_branch }}"

      - name: Cherry-pick commit
        working-directory: ./repo
        run: |
          COMMIT_ID="${{ github.event.inputs.commit_id }}"
          TARGET_BRANCH="${{ github.event.inputs.target_branch }}"

          echo "üçí Cherry-picking commit $COMMIT_ID into branch $TARGET_BRANCH"

          if git cherry-pick "$COMMIT_ID"; then
            echo "‚úÖ Cherry-pick successful"
          else
            echo "‚ùå Cherry-pick failed with conflicts"
            echo "Conflict details:"
            git status
            exit 1
          fi

      - name: Push changes
        working-directory: ./repo
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMIT_ID="${{ github.event.inputs.commit_id }}"
          TARGET_BRANCH="${{ github.event.inputs.target_branch }}"

          echo "üì§ Pushing cherry-picked commit to $TARGET_BRANCH"
          REPO_URL="https://x-access-token:${GH_TOKEN}@github.com"
          REPO_URL="${REPO_URL}/${{ github.repository }}.git"
          git push "$REPO_URL" "$TARGET_BRANCH"
          echo "‚úÖ Successfully cherry-picked $COMMIT_ID to $TARGET_BRANCH"

  create-branch-from-upstream:
    if: ${{ github.event.inputs.operation == 'Create Branch from Upstream' }}
    runs-on: ubuntu-latest

    steps:
      - name: Validate inputs
        run: |
          if [ -z "${{ github.event.inputs.upstream_branch }}" ]; then
            echo "‚ùå Error: 'upstream_branch' is required for Create Branch operation"
            exit 1
          fi

      - name: Authenticate GitHub CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Clone repository
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh auth setup-git
          gh repo clone "${{ github.repository }}" repo
          cd repo
          git fetch origin

      - name: Configure Git
        working-directory: ./repo
        run: |
          git config user.name "React-Native-Windows Bot"
          git config user.email "53619745+rnbot@users.noreply.github.com"

      - name: Add upstream remote and fetch branch
        working-directory: ./repo
        run: |
          UPSTREAM_BRANCH="${{ github.event.inputs.upstream_branch }}"

          echo "üîó Adding upstream remote (microsoft/react-native-windows)"
          git remote get-url upstream 2>/dev/null || git remote add upstream https://github.com/microsoft/react-native-windows.git

          echo "üì• Fetching upstream branch: $UPSTREAM_BRANCH"
          if ! git fetch upstream "$UPSTREAM_BRANCH"; then
            echo "‚ùå Failed to fetch branch '$UPSTREAM_BRANCH' from upstream."
            echo "Please verify that the branch exists in microsoft/react-native-windows."
            exit 1
          fi

          echo "‚úÖ Successfully fetched upstream branch: $UPSTREAM_BRANCH"

      - name: Create and push new branch
        working-directory: ./repo
        run: |
          UPSTREAM_BRANCH="${{ github.event.inputs.upstream_branch }}"
          NEW_BRANCH="${{ github.event.inputs.new_branch_name }}"

          # Use upstream branch name if new branch name is not specified
          if [ -z "$NEW_BRANCH" ]; then
            NEW_BRANCH="$UPSTREAM_BRANCH"
          fi

          echo "üåø Creating new branch: $NEW_BRANCH from upstream/$UPSTREAM_BRANCH"

          # Check if the branch already exists in the fork
          if git ls-remote --heads origin "$NEW_BRANCH" | grep -q "refs/heads/$NEW_BRANCH$"; then
            echo "‚ùå Branch '$NEW_BRANCH' already exists in your fork."
            echo "Please specify a different branch name or delete the existing branch first."
            exit 1
          fi

          # Create the new branch based on upstream
          git checkout -b "$NEW_BRANCH" "upstream/$UPSTREAM_BRANCH"

          echo "üì§ Pushing new branch to fork"
          git push origin "$NEW_BRANCH"

          echo "‚úÖ Successfully created branch '$NEW_BRANCH' from upstream '$UPSTREAM_BRANCH'"
          echo ""
          echo "üìã Branch details:"
          echo "   - Source: microsoft/react-native-windows/$UPSTREAM_BRANCH"
          echo "   - Destination: ${{ github.repository }}/$NEW_BRANCH"
